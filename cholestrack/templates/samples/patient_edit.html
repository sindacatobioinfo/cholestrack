{% extends "base.html" %}

{% block content %}
<style>
    /* Patient edit form styling - same as create */
    .patient-form-container {
        max-width: 900px;
        width: 90%;
        margin: 40px auto;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        background-color: #ffffff;
        font-family: Arial, sans-serif;
        box-sizing: border-box;
    }

    .form-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #ffc107;
    }

    .form-header h2 {
        color: #ffc107;
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

    .form-header p {
        color: #6c757d;
        font-size: 14px;
        margin-top: 8px;
    }

    .info-message {
        background-color: #fff3cd;
        border-left: 4px solid #856404;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 5px;
    }

    .info-message p {
        margin: 0;
        color: #856404;
        font-size: 14px;
        line-height: 1.6;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 25px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
    }

    .form-section h3 {
        color: #ffc107;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .patient-form-container form p {
        margin-bottom: 20px !important;
        text-align: left;
        display: block !important;
    }

    .patient-form-container label {
        display: block !important;
        margin-bottom: 8px !important;
        color: #333 !important;
        font-size: 14px !important;
        font-weight: 600 !important;
    }

    .patient-form-container input[type="text"],
    .patient-form-container input[type="date"],
    .patient-form-container select,
    .patient-form-container textarea {
        width: 100% !important;
        height: auto !important;
        padding: 12px 15px !important;
        border: 1px solid #ccc !important;
        border-radius: 5px !important;
        box-sizing: border-box !important;
        font-size: 15px !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background-color: white !important;
        transition: border-color 0.3s;
    }

    .patient-form-container input:focus,
    .patient-form-container select:focus,
    .patient-form-container textarea:focus {
        border-color: #ffc107 !important;
        outline: none !important;
        box-shadow: 0 0 5px rgba(255, 193, 7, 0.2) !important;
    }

    .patient-form-container input:disabled {
        background-color: #e9ecef !important;
        cursor: not-allowed;
    }

    .patient-form-container .errorlist {
        list-style: none;
        color: #dc3545;
        font-size: 13px;
        margin-top: 5px;
        padding: 0;
        background-color: #f8d7da;
        padding: 8px 12px;
        border-radius: 4px;
        border-left: 3px solid #dc3545;
    }

    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }

    .success-message {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 12px;
        border-radius: 5px;
        margin-bottom: 20px;
        text-align: center;
    }

    .button-container {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }

    .btn-submit {
        flex: 1;
        padding: 14px;
        background-color: #ffc107;
        color: #333;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-submit:hover {
        background-color: #e0a800;
    }

    .btn-cancel {
        flex: 1;
        padding: 14px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background-color 0.3s;
        text-decoration: none;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-cancel:hover {
        background-color: #5a6268;
        color: white;
        text-decoration: none;
    }

    .help-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
        display: block;
    }

    .required-indicator::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
</style>

<div class="patient-form-container">
    <div class="form-header">
        <h2><i class="fas fa-user-edit"></i> Edit Patient Record</h2>
        <p>Update patient information and clinical data</p>
    </div>

    <div class="info-message">
        <p>
            <i class="fas fa-info-circle"></i>
            <strong>Editing:</strong> {{ patient.patient_id }} - {{ patient.name }}
        </p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}error-message{% elif message.tags == 'success' %}success-message{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if form.non_field_errors %}
        <div class="error-message">
            {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Patient Identification Section -->
        <div class="form-section">
            <h3><i class="fas fa-id-card"></i> Patient Identification</h3>

            <p>
                <label for="{{ form.patient_id.id_for_label }}" class="required-indicator">{{ form.patient_id.label }}</label>
                <input type="text" value="{{ patient.patient_id }}" class="form-control" disabled readonly>
                {{ form.patient_id.as_hidden }}
                <span class="help-text">Patient ID cannot be changed after creation</span>
            </p>

            <p>
                <label for="{{ form.name.id_for_label }}" class="required-indicator">{{ form.name.label }}</label>
                {{ form.name }}
                {% if form.name.errors %}
                    <ul class="errorlist">
                        {% for error in form.name.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.name.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.birth_date.id_for_label }}">{{ form.birth_date.label }}</label>
                {{ form.birth_date }}
                {% if form.birth_date.errors %}
                    <ul class="errorlist">
                        {% for error in form.birth_date.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.birth_date.help_text }}</span>
            </p>
        </div>

        <!-- Clinical Information Section -->
        <div class="form-section">
            <h3><i class="fas fa-stethoscope"></i> Clinical Information</h3>

            <p>
                <label for="{{ form.diagnosis.id_for_label }}">{{ form.diagnosis.label }}</label>
                {{ form.diagnosis }}
                {% if form.diagnosis.errors %}
                    <ul class="errorlist">
                        {% for error in form.diagnosis.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.diagnosis.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.phenotype.id_for_label }}">{{ form.phenotype.label }}</label>
                {{ form.phenotype }}
                {% if form.phenotype.errors %}
                    <ul class="errorlist">
                        {% for error in form.phenotype.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.phenotype.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.additional_clinical_info.id_for_label }}">{{ form.additional_clinical_info.label }}</label>
                {{ form.additional_clinical_info }}
                {% if form.additional_clinical_info.errors %}
                    <ul class="errorlist">
                        {% for error in form.additional_clinical_info.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.additional_clinical_info.help_text }}</span>
            </p>

            <!-- Signs and Symptoms HPO Autocomplete -->
            <p>
                <label for="phenotype-input">Signs and Symptoms (HPO)</label>
                <div class="relative">
                    <input type="text"
                           id="phenotype-input"
                           class="form-control"
                           placeholder="Type at least 5 characters to search HPO terms..."
                           autocomplete="off">
                    <div id="phenotype-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="position: absolute; z-index: 1000; display: none;"></div>
                </div>
                <span class="help-text">Search and add HPO phenotype terms describing the patient's signs and symptoms</span>

                <!-- Selected phenotypes list -->
                <div id="selected-phenotypes" style="margin-top: 15px;"></div>

                <!-- Hidden field to store JSON -->
                {{ form.signs_and_symptoms_json }}
            </p>

            <!-- Administered Drugs Autocomplete -->
            <p>
                <label for="drug-input">Administered Drugs</label>
                <div class="relative">
                    <input type="text"
                           id="drug-input"
                           class="form-control"
                           placeholder="Type at least 3 characters to search drugs/chemicals..."
                           autocomplete="off">
                    <div id="drug-dropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="position: absolute; z-index: 1000; display: none;"></div>
                </div>
                <span class="help-text">Search and add drugs/chemicals administered to the patient</span>

                <!-- Selected drugs list -->
                <div id="selected-drugs" style="margin-top: 15px;"></div>

                <!-- Hidden field to store JSON -->
                {{ form.administered_drugs_json }}
            </p>
        </div>

        <!-- Analysis Information Section -->
        <div class="form-section">
            <h3><i class="fas fa-dna"></i> Genomic Analysis Information</h3>

            <p>
                <label for="{{ form.main_exome_result.id_for_label }}">{{ form.main_exome_result.label }}</label>
                {{ form.main_exome_result }}
                {% if form.main_exome_result.errors %}
                    <ul class="errorlist">
                        {% for error in form.main_exome_result.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.main_exome_result.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.analysis_status.id_for_label }}">{{ form.analysis_status.label }}</label>
                {{ form.analysis_status }}
                {% if form.analysis_status.errors %}
                    <ul class="errorlist">
                        {% for error in form.analysis_status.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.analysis_status.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.responsible_user.id_for_label }}">{{ form.responsible_user.label }}</label>
                {{ form.responsible_user }}
                {% if form.responsible_user.errors %}
                    <ul class="errorlist">
                        {% for error in form.responsible_user.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.responsible_user.help_text }}</span>
            </p>

            <p>
                <label for="{{ form.notes.id_for_label }}">{{ form.notes.label }}</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <ul class="errorlist">
                        {% for error in form.notes.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <span class="help-text">{{ form.notes.help_text }}</span>
            </p>
        </div>

        <div class="button-container">
            <button type="submit" class="btn-submit">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <a href="{% url 'samples:sample_detail' patient_id=patient.patient_id %}" class="btn-cancel">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>

    <div style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 12px;">
        <p>Fields marked with <span style="color: #dc3545;">*</span> are required.</p>
    </div>
</div>

<!-- HPO Phenotype Autocomplete JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phenotypeInput = document.getElementById('phenotype-input');
    const dropdown = document.getElementById('phenotype-dropdown');
    const selectedContainer = document.getElementById('selected-phenotypes');
    const hiddenField = document.getElementById('{{ form.signs_and_symptoms_json.id_for_label }}');

    let selectedPhenotypes = [];
    let debounceTimer;

    // Load existing phenotypes from hidden field
    function loadExistingPhenotypes() {
        const existingData = hiddenField.value;
        if (existingData) {
            try {
                selectedPhenotypes = JSON.parse(existingData);
                renderSelectedPhenotypes();
            } catch (e) {
                console.error('Error parsing existing phenotypes:', e);
                selectedPhenotypes = [];
            }
        }
    }

    // Initialize on page load
    loadExistingPhenotypes();

    // Handle input for autocomplete
    phenotypeInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        // Clear previous timer
        clearTimeout(debounceTimer);

        // Only trigger with 5+ characters
        if (query.length < 5) {
            dropdown.style.display = 'none';
            return;
        }

        // Debounce to avoid too many requests
        debounceTimer = setTimeout(function() {
            fetchAutocomplete(query);
        }, 300);
    });

    // Fetch autocomplete results
    async function fetchAutocomplete(query) {
        try {
            const response = await fetch(`/smart-search/autocomplete/?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                displayResults(data.results);
            } else {
                dropdown.style.display = 'none';
            }
        } catch (error) {
            console.error('Autocomplete error:', error);
            dropdown.style.display = 'none';
        }
    }

    // Display autocomplete results
    function displayResults(results) {
        dropdown.innerHTML = '';

        results.forEach(result => {
            // Check if already selected
            const alreadySelected = selectedPhenotypes.some(p => p.hpo_id === result.hpo_id);

            const item = document.createElement('div');
            item.style.padding = '12px 16px';
            item.style.cursor = alreadySelected ? 'default' : 'pointer';
            item.style.borderBottom = '1px solid #e5e7eb';
            item.style.backgroundColor = alreadySelected ? '#f3f4f6' : 'white';

            if (!alreadySelected) {
                item.onmouseover = function() { this.style.backgroundColor = '#eff6ff'; };
                item.onmouseout = function() { this.style.backgroundColor = 'white'; };
            }

            item.innerHTML = `
                <div style="font-weight: 500; color: ${alreadySelected ? '#9ca3af' : '#111827'};">
                    ${escapeHtml(result.name)}
                    ${alreadySelected ? '<span style="color: #059669; font-size: 12px; margin-left: 8px;">✓ Added</span>' : ''}
                </div>
                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(result.hpo_id)}</div>
            `;

            if (!alreadySelected) {
                item.addEventListener('click', function() {
                    addPhenotype({
                        hpo_id: result.hpo_id,
                        name: result.name
                    });
                    phenotypeInput.value = '';
                    dropdown.style.display = 'none';
                });
            }

            dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';
    }

    // Add phenotype to selected list
    function addPhenotype(phenotype) {
        // Check if already exists
        if (selectedPhenotypes.some(p => p.hpo_id === phenotype.hpo_id)) {
            return;
        }

        selectedPhenotypes.push(phenotype);
        updateHiddenField();
        renderSelectedPhenotypes();
    }

    // Remove phenotype from selected list
    function removePhenotype(hpoId) {
        selectedPhenotypes = selectedPhenotypes.filter(p => p.hpo_id !== hpoId);
        updateHiddenField();
        renderSelectedPhenotypes();
    }

    // Update hidden field with JSON
    function updateHiddenField() {
        hiddenField.value = JSON.stringify(selectedPhenotypes);
    }

    // Render selected phenotypes as tags
    function renderSelectedPhenotypes() {
        if (selectedPhenotypes.length === 0) {
            selectedContainer.innerHTML = '<p style="color: #6c757d; font-size: 14px; font-style: italic;">No phenotypes selected yet</p>';
            return;
        }

        selectedContainer.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 8px;"></div>';
        const tagsContainer = selectedContainer.firstElementChild;

        selectedPhenotypes.forEach(phenotype => {
            const tag = document.createElement('div');
            tag.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 6px; font-size: 14px; color: #0c4a6e;';

            tag.innerHTML = `
                <div>
                    <div style="font-weight: 600;">${escapeHtml(phenotype.name)}</div>
                    <div style="font-size: 11px; color: #0369a1;">${escapeHtml(phenotype.hpo_id)}</div>
                </div>
                <button type="button"
                        style="background: none; border: none; color: #0c4a6e; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; margin-left: 4px;"
                        title="Remove phenotype"
                        data-hpo-id="${escapeHtml(phenotype.hpo_id)}">
                    ×
                </button>
            `;

            // Add remove handler
            const removeBtn = tag.querySelector('button');
            removeBtn.addEventListener('click', function() {
                removePhenotype(this.getAttribute('data-hpo-id'));
            });

            tagsContainer.appendChild(tag);
        });
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== phenotypeInput && e.target !== dropdown && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // Hide dropdown on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            dropdown.style.display = 'none';
        }
    });

    // Clear input when it loses focus
    phenotypeInput.addEventListener('blur', function() {
        setTimeout(function() {
            dropdown.style.display = 'none';
        }, 200);
    });

    // ============== Administered Drugs Autocomplete ==============
    const drugInput = document.getElementById('drug-input');
    const drugDropdown = document.getElementById('drug-dropdown');
    const selectedDrugsContainer = document.getElementById('selected-drugs');
    const drugsHiddenField = document.getElementById('{{ form.administered_drugs_json.id_for_label }}');

    let selectedDrugs = [];
    let drugDebounceTimer;

    // Load existing drugs from hidden field
    function loadExistingDrugs() {
        const existingData = drugsHiddenField.value;
        if (existingData) {
            try {
                selectedDrugs = JSON.parse(existingData);
                renderSelectedDrugs();
            } catch (e) {
                console.error('Error parsing existing drugs:', e);
                selectedDrugs = [];
            }
        }
    }

    // Initialize on page load
    loadExistingDrugs();

    // Handle input for autocomplete
    drugInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        // Clear previous timer
        clearTimeout(drugDebounceTimer);

        // Only trigger with 3+ characters
        if (query.length < 3) {
            drugDropdown.style.display = 'none';
            return;
        }

        // Debounce to avoid too many requests
        drugDebounceTimer = setTimeout(function() {
            fetchDrugAutocomplete(query);
        }, 300);
    });

    // Fetch autocomplete results
    async function fetchDrugAutocomplete(query) {
        try {
            const response = await fetch(`/smart-search/autocomplete-chemicals/?q=${encodeURIComponent(query)}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                displayDrugResults(data.results);
            } else {
                drugDropdown.style.display = 'none';
            }
        } catch (error) {
            console.error('Drug autocomplete error:', error);
            drugDropdown.style.display = 'none';
        }
    }

    // Display autocomplete results
    function displayDrugResults(results) {
        drugDropdown.innerHTML = '';

        results.forEach(result => {
            // Check if already selected
            const alreadySelected = selectedDrugs.some(d => d.chemical_id === result.chemical_id);

            const item = document.createElement('div');
            item.style.padding = '12px 16px';
            item.style.cursor = alreadySelected ? 'default' : 'pointer';
            item.style.borderBottom = '1px solid #e5e7eb';
            item.style.backgroundColor = alreadySelected ? '#f3f4f6' : 'white';

            if (!alreadySelected) {
                item.onmouseover = function() { this.style.backgroundColor = '#eff6ff'; };
                item.onmouseout = function() { this.style.backgroundColor = 'white'; };
            }

            item.innerHTML = `
                <div style="font-weight: 500; color: ${alreadySelected ? '#9ca3af' : '#111827'};">
                    ${escapeHtml(result.name)}
                    ${alreadySelected ? '<span style="color: #059669; font-size: 12px; margin-left: 8px;">✓ Added</span>' : ''}
                </div>
                <div style="font-size: 12px; color: #6b7280;">${escapeHtml(result.chemical_id)}</div>
            `;

            if (!alreadySelected) {
                item.addEventListener('click', function() {
                    addDrug({
                        chemical_id: result.chemical_id,
                        name: result.name
                    });
                    drugInput.value = '';
                    drugDropdown.style.display = 'none';
                });
            }

            drugDropdown.appendChild(item);
        });

        drugDropdown.style.display = 'block';
    }

    // Add drug to selected list
    function addDrug(drug) {
        // Check if already exists
        if (selectedDrugs.some(d => d.chemical_id === drug.chemical_id)) {
            return;
        }

        selectedDrugs.push(drug);
        updateDrugsHiddenField();
        renderSelectedDrugs();
    }

    // Remove drug from selected list
    function removeDrug(chemicalId) {
        selectedDrugs = selectedDrugs.filter(d => d.chemical_id !== chemicalId);
        updateDrugsHiddenField();
        renderSelectedDrugs();
    }

    // Update hidden field with JSON
    function updateDrugsHiddenField() {
        drugsHiddenField.value = JSON.stringify(selectedDrugs);
    }

    // Render selected drugs as tags
    function renderSelectedDrugs() {
        if (selectedDrugs.length === 0) {
            selectedDrugsContainer.innerHTML = '<p style="color: #6c757d; font-size: 14px; font-style: italic;">No drugs selected yet</p>';
            return;
        }

        selectedDrugsContainer.innerHTML = '<div style="display: flex; flex-wrap: wrap; gap: 8px;"></div>';
        const tagsContainer = selectedDrugsContainer.firstElementChild;

        selectedDrugs.forEach(drug => {
            const tag = document.createElement('div');
            tag.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; font-size: 14px; color: #78350f;';

            tag.innerHTML = `
                <div>
                    <div style="font-weight: 600;">${escapeHtml(drug.name)}</div>
                    <div style="font-size: 11px; color: #92400e;">${escapeHtml(drug.chemical_id)}</div>
                </div>
                <button type="button"
                        style="background: none; border: none; color: #78350f; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; margin-left: 4px;"
                        title="Remove drug"
                        data-chemical-id="${escapeHtml(drug.chemical_id)}">
                    ×
                </button>
            `;

            // Add remove handler
            const removeBtn = tag.querySelector('button');
            removeBtn.addEventListener('click', function() {
                removeDrug(this.getAttribute('data-chemical-id'));
            });

            tagsContainer.appendChild(tag);
        });
    }

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== drugInput && e.target !== drugDropdown && !drugDropdown.contains(e.target)) {
            drugDropdown.style.display = 'none';
        }
    });

    // Clear input when it loses focus
    drugInput.addEventListener('blur', function() {
        setTimeout(function() {
            drugDropdown.style.display = 'none';
        }, 200);
    });
});
</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Role Change Requests - Admin Center - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-clipboard-list text-purple-600 mr-2"></i> Role Change Requests
                </h1>
                <p class="text-gray-600">Review and manage user role change requests</p>
            </div>
            <a href="{% url 'home:admin_center' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i> Back to Admin Center
            </a>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700">Filter by Status:</label>
            <a href="?status=pending"
               class="px-4 py-2 rounded-md text-sm font-medium {% if status_filter == 'pending' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-clock mr-1"></i> Pending
            </a>
            <a href="?status=approved"
               class="px-4 py-2 rounded-md text-sm font-medium {% if status_filter == 'approved' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-check mr-1"></i> Approved
            </a>
            <a href="?status=denied"
               class="px-4 py-2 rounded-md text-sm font-medium {% if status_filter == 'denied' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-times mr-1"></i> Denied
            </a>
            <a href="?status=all"
               class="px-4 py-2 rounded-md text-sm font-medium {% if status_filter == 'all' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                <i class="fas fa-list mr-1"></i> All
            </a>
        </div>
    </div>

    <!-- Requests List -->
    <div class="space-y-4">
        {% for request in page_obj %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden border-l-4
                    {% if request.status == 'PENDING' %}border-yellow-500
                    {% elif request.status == 'APPROVED' %}border-green-500
                    {% elif request.status == 'DENIED' %}border-red-500
                    {% endif %}">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <!-- Request Info -->
                    <div class="flex-1">
                        <div class="flex items-center mb-3">
                            <div class="bg-gray-200 rounded-full p-3 mr-4">
                                <i class="fas fa-user text-gray-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">{{ request.user.username }}</h3>
                                <p class="text-sm text-gray-600">{{ request.user.first_name }} {{ request.user.last_name }}</p>
                                <p class="text-xs text-gray-500">{{ request.user.email }}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">Current Role:</p>
                                <p class="text-md font-semibold text-gray-900">
                                    <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-800">
                                        {{ request.get_current_role_display }}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Requested Role:</p>
                                <p class="text-md font-semibold text-gray-900">
                                    <span class="px-3 py-1 rounded-full bg-purple-100 text-purple-800">
                                        {{ request.get_requested_role_display }}
                                    </span>
                                </p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-1">Reason:</p>
                            <div class="bg-gray-50 rounded-md p-3 text-sm text-gray-900">
                                {{ request.reason }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600">Requested:</p>
                                <p class="font-medium">{{ request.created_at|date:"Y-m-d H:i" }}</p>
                            </div>
                            {% if request.reviewed_at %}
                            <div>
                                <p class="text-gray-600">Reviewed:</p>
                                <p class="font-medium">{{ request.reviewed_at|date:"Y-m-d H:i" }}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Reviewed By:</p>
                                <p class="font-medium">{{ request.reviewed_by.username }}</p>
                            </div>
                            {% endif %}
                        </div>

                        {% if request.admin_notes %}
                        <div class="mt-4">
                            <p class="text-sm text-gray-600 mb-1">Admin Notes:</p>
                            <div class="bg-blue-50 rounded-md p-3 text-sm text-gray-900">
                                {{ request.admin_notes }}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Status Badge -->
                    <div class="ml-4">
                        {% if request.status == 'PENDING' %}
                        <span class="px-4 py-2 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold">
                            <i class="fas fa-clock"></i> Pending
                        </span>
                        {% elif request.status == 'APPROVED' %}
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-800 text-sm font-semibold">
                            <i class="fas fa-check"></i> Approved
                        </span>
                        {% elif request.status == 'DENIED' %}
                        <span class="px-4 py-2 rounded-full bg-red-100 text-red-800 text-sm font-semibold">
                            <i class="fas fa-times"></i> Denied
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Actions (only for pending requests) -->
                {% if request.status == 'PENDING' %}
                <div class="mt-6 pt-6 border-t border-gray-200 flex justify-end space-x-3">
                    <!-- Deny Form -->
                    <button onclick="showDenyModal{{ request.id }}()"
                            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition font-medium">
                        <i class="fas fa-times mr-2"></i> Deny Request
                    </button>

                    <!-- Approve Form -->
                    <button onclick="showApproveModal{{ request.id }}()"
                            class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-medium">
                        <i class="fas fa-check mr-2"></i> Approve Request
                    </button>
                </div>

                <!-- Approve Modal -->
                <div id="approveModal{{ request.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Approve Role Change Request</h3>
                            <form method="post" action="{% url 'home:admin_approve_role_request' request.id %}">
                                {% csrf_token %}
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes (Optional):</label>
                                    <textarea name="admin_notes"
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                              placeholder="Add any notes about this approval..."></textarea>
                                </div>
                                <div class="flex justify-end space-x-3">
                                    <button type="button"
                                            onclick="hideApproveModal{{ request.id }}()"
                                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                        Confirm Approval
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Deny Modal -->
                <div id="denyModal{{ request.id }}" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Deny Role Change Request</h3>
                            <form method="post" action="{% url 'home:admin_deny_role_request' request.id %}">
                                {% csrf_token %}
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Denial (Required):</label>
                                    <textarea name="admin_notes"
                                              rows="3"
                                              required
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                                              placeholder="Explain why this request is being denied..."></textarea>
                                </div>
                                <div class="flex justify-end space-x-3">
                                    <button type="button"
                                            onclick="hideDenyModal{{ request.id }}()"
                                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                                        Cancel
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                        Confirm Denial
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <script>
                    function showApproveModal{{ request.id }}() {
                        document.getElementById('approveModal{{ request.id }}').classList.remove('hidden');
                    }
                    function hideApproveModal{{ request.id }}() {
                        document.getElementById('approveModal{{ request.id }}').classList.add('hidden');
                    }
                    function showDenyModal{{ request.id }}() {
                        document.getElementById('denyModal{{ request.id }}').classList.remove('hidden');
                    }
                    function hideDenyModal{{ request.id }}() {
                        document.getElementById('denyModal{{ request.id }}').classList.add('hidden');
                    }
                </script>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Role Change Requests</h3>
            <p class="text-gray-500">There are no role change requests matching your filter.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="mt-6 bg-white rounded-lg shadow-md p-4 flex items-center justify-between">
        <div class="text-sm text-gray-700">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} requests
        </div>
        <div class="flex space-x-2">
            {% if page_obj.has_previous %}
            <a href="?page=1&status={{ status_filter }}"
               class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50">
                First
            </a>
            <a href="?page={{ page_obj.previous_page_number }}&status={{ status_filter }}"
               class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50">
                Previous
            </a>
            {% endif %}

            <span class="px-3 py-2 border border-purple-500 rounded-md text-sm bg-purple-50 text-purple-600">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&status={{ status_filter }}"
               class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50">
                Next
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}&status={{ status_filter }}"
               class="px-3 py-2 border border-gray-300 rounded-md text-sm bg-white hover:bg-gray-50">
                Last
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    .btn {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.3s;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }
</style>
{% endblock %}
